<UserControl x:Class="BlueMeter.WPF.Views.Checklist.ChecklistView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:BlueMeter.WPF.Views.Checklist"
             xmlns:vm="clr-namespace:BlueMeter.WPF.ViewModels.Checklist"
             xmlns:models="clr-namespace:BlueMeter.WPF.Models.Checklist"
             xmlns:converters="clr-namespace:BlueMeter.WPF.Converters.Checklist"
             xmlns:behaviors="clr-namespace:BlueMeter.WPF.Behaviors.Checklist"
             d:DataContext="{d:DesignInstance Type=vm:ChecklistViewModel}"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="400"
             Background="#1E1E1E">

    <UserControl.Resources>
        <!-- Merge Checklist Styles -->
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Styles/ChecklistStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <!-- Converters -->
            <converters:CategoryToColorConverter x:Key="CategoryToColorConverter"/>
            <converters:CategoryToBackgroundConverter x:Key="CategoryToBackgroundConverter"/>
            <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Event Timers -->
            <RowDefinition Height="*"/>    <!-- Task Lists -->
            <RowDefinition Height="Auto"/> <!-- Footer Actions -->
        </Grid.RowDefinitions>

        <!-- ========== HEADER ========== -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Search Box -->
            <TextBox Grid.Column="0"
                     x:Name="SearchTextBox"
                     Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                     Style="{StaticResource SearchTextBox}"
                     Margin="0,0,8,0"/>

            <!-- Profile Switcher -->
            <ComboBox Grid.Column="1"
                      ItemsSource="{Binding Profiles}"
                      SelectedItem="{Binding CurrentProfile}"
                      DisplayMemberPath="ProfileName"
                      Style="{StaticResource ProfileComboBox}"
                      MinWidth="150"
                      Margin="0,0,4,0"/>

            <!-- Profile Management Buttons -->
            <StackPanel Grid.Column="2" Orientation="Horizontal">
                <Button Content="+"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding CreateNewProfileCommand}"
                        ToolTip="Neues Profil erstellen"
                        FontWeight="Bold"
                        FontSize="16"
                        Padding="8,2"
                        Margin="0,0,4,0"/>
                <Button Content="−"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding DeleteProfileCommand}"
                        CommandParameter="{Binding CurrentProfile}"
                        ToolTip="Aktuelles Profil löschen"
                        FontWeight="Bold"
                        FontSize="16"
                        Padding="8,2"/>
            </StackPanel>
        </Grid>

        <!-- ========== EVENT TIMERS ========== -->
        <ScrollViewer Grid.Row="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Disabled"
                      Margin="0,0,0,12">
            <ItemsControl ItemsSource="{Binding EventTimers}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource EventTimerBorder}"
                                MinWidth="140">
                            <StackPanel>
                                <!-- Event Name -->
                                <TextBlock Text="{Binding EventName}"
                                           FontWeight="SemiBold"
                                           FontSize="12"
                                           Foreground="#FFFFFF"
                                           TextTrimming="CharacterEllipsis"/>

                                <!-- Status Text -->
                                <TextBlock Text="{Binding StatusText}"
                                           FontSize="10"
                                           Foreground="#AAAAAA"
                                           Margin="0,2,0,0"/>

                                <!-- Timer -->
                                <TextBlock Text="{Binding FormattedTime}"
                                           FontSize="14"
                                           FontWeight="Bold"
                                           Foreground="#4CAF50"
                                           Margin="0,4,0,0"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- ========== TASK LISTS ========== -->
        <ScrollViewer Grid.Row="2"
                      VerticalScrollBarVisibility="Auto">
            <StackPanel>

                <!-- DAILY TASKS SECTION -->
                <Expander IsExpanded="True" Margin="0,0,0,12">
                    <Expander.Header>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Daily Tasks"
                                       Style="{StaticResource SectionHeaderText}"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding DailyResetTimer}"
                                       Foreground="#4CAF50"
                                       FontWeight="Bold"
                                       FontSize="12"
                                       VerticalAlignment="Center"
                                       Margin="12,0,12,0"/>
                            <TextBlock Grid.Column="2"
                                       Text="{Binding FilteredDailyTasks.Count, StringFormat='{}{0} tasks'}"
                                       Foreground="#AAAAAA"
                                       VerticalAlignment="Center"
                                       Margin="0,0,0,0"/>
                        </Grid>
                    </Expander.Header>

                    <ItemsControl ItemsSource="{Binding FilteredDailyTasks}"
                                  Margin="0,8,0,0"
                                  Focusable="True">
                        <i:Interaction.Behaviors>
                            <behaviors:KeyboardNavigationBehavior
                                ToggleCommand="{Binding ToggleTaskCommand}"
                                SearchBox="{Binding ElementName=SearchTextBox}"/>
                        </i:Interaction.Behaviors>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:ChecklistTask}">
                                <Border Style="{StaticResource TaskItemBorder}"
                                        Background="{Binding Category, Converter={StaticResource CategoryToBackgroundConverter}}"
                                        MouseLeftButtonDown="TaskItem_MouseLeftButtonDown">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/> <!-- Checkbox -->
                                            <ColumnDefinition Width="*"/>    <!-- Label -->
                                            <ColumnDefinition Width="Auto"/> <!-- Progress -->
                                        </Grid.ColumnDefinitions>

                                        <!-- Checkbox -->
                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsCompleted}"
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,12,0"
                                                  Cursor="Hand"/>

                                        <!-- Task Label -->
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Label}"
                                                   Style="{StaticResource CompletedTaskText}"
                                                   VerticalAlignment="Center"/>

                                        <!-- Progress Section (only for incremental tasks) -->
                                        <StackPanel Grid.Column="2"
                                                    Visibility="{Binding IsIncremental, Converter={StaticResource BoolToVisConverter}}"
                                                    VerticalAlignment="Center">

                                            <!-- Counter Controls -->
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                <!-- Decrement Button -->
                                                <Button Content="-"
                                                        Style="{StaticResource CounterButton}"
                                                        Command="{Binding DataContext.DecrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Click to subtract (Hold for rapid)">
                                                    <i:Interaction.Behaviors>
                                                        <behaviors:HoldClickBehavior
                                                            HoldCommand="{Binding DataContext.DecrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            Interval="100"
                                                            InitialDelay="300"/>
                                                    </i:Interaction.Behaviors>
                                                </Button>

                                                <!-- Progress Text -->
                                                <TextBlock VerticalAlignment="Center"
                                                           Margin="8,0">
                                                    <Run Text="{Binding CurrentProgress, Mode=OneWay}"
                                                         FontWeight="Bold"
                                                         Foreground="#FFFFFF"/>
                                                    <Run Text="/"
                                                         Foreground="#AAAAAA"/>
                                                    <Run Text="{Binding MaxProgress, Mode=OneWay}"
                                                         Foreground="#AAAAAA"/>
                                                </TextBlock>

                                                <!-- Increment Button -->
                                                <Button Content="+"
                                                        Style="{StaticResource CounterButton}"
                                                        Command="{Binding DataContext.IncrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}"
                                                        ToolTip="Click to add (Hold for rapid)">
                                                    <i:Interaction.Behaviors>
                                                        <behaviors:HoldClickBehavior
                                                            HoldCommand="{Binding DataContext.IncrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            Interval="100"
                                                            InitialDelay="300"/>
                                                    </i:Interaction.Behaviors>
                                                </Button>
                                            </StackPanel>

                                            <!-- Progress Bar -->
                                            <ProgressBar Value="{Binding CurrentProgress}"
                                                         Maximum="{Binding MaxProgress}"
                                                         Style="{StaticResource TaskProgressBar}"
                                                         MinWidth="120"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Expander>

                <!-- WEEKLY TASKS SECTION -->
                <Expander IsExpanded="True">
                    <Expander.Header>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Weekly Tasks"
                                       Style="{StaticResource SectionHeaderText}"/>
                            <TextBlock Grid.Column="1"
                                       Text="{Binding WeeklyResetTimer}"
                                       Foreground="#2196F3"
                                       FontWeight="Bold"
                                       FontSize="12"
                                       VerticalAlignment="Center"
                                       Margin="12,0,12,0"/>
                            <TextBlock Grid.Column="2"
                                       Text="{Binding FilteredWeeklyTasks.Count, StringFormat='{}{0} tasks'}"
                                       Foreground="#AAAAAA"
                                       VerticalAlignment="Center"
                                       Margin="0,0,0,0"/>
                        </Grid>
                    </Expander.Header>

                    <ItemsControl ItemsSource="{Binding FilteredWeeklyTasks}"
                                  Margin="0,8,0,0"
                                  Focusable="True">
                        <i:Interaction.Behaviors>
                            <behaviors:KeyboardNavigationBehavior
                                ToggleCommand="{Binding ToggleTaskCommand}"
                                SearchBox="{Binding ElementName=SearchTextBox}"/>
                        </i:Interaction.Behaviors>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:ChecklistTask}">
                                <Border Style="{StaticResource TaskItemBorder}"
                                        Background="{Binding Category, Converter={StaticResource CategoryToBackgroundConverter}}"
                                        MouseLeftButtonDown="TaskItem_MouseLeftButtonDown">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsCompleted}"
                                                  VerticalAlignment="Center"
                                                  Margin="0,0,12,0"
                                                  Cursor="Hand"/>

                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding Label}"
                                                   Style="{StaticResource CompletedTaskText}"
                                                   VerticalAlignment="Center"/>

                                        <StackPanel Grid.Column="2"
                                                    Visibility="{Binding IsIncremental, Converter={StaticResource BoolToVisConverter}}"
                                                    VerticalAlignment="Center">

                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                <Button Content="-"
                                                        Style="{StaticResource CounterButton}"
                                                        Command="{Binding DataContext.DecrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}">
                                                    <i:Interaction.Behaviors>
                                                        <behaviors:HoldClickBehavior
                                                            HoldCommand="{Binding DataContext.DecrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            Interval="100"
                                                            InitialDelay="300"/>
                                                    </i:Interaction.Behaviors>
                                                </Button>

                                                <TextBlock VerticalAlignment="Center" Margin="8,0">
                                                    <Run Text="{Binding CurrentProgress, Mode=OneWay}"
                                                         FontWeight="Bold"
                                                         Foreground="#FFFFFF"/>
                                                    <Run Text="/" Foreground="#AAAAAA"/>
                                                    <Run Text="{Binding MaxProgress, Mode=OneWay}"
                                                         Foreground="#AAAAAA"/>
                                                </TextBlock>

                                                <Button Content="+"
                                                        Style="{StaticResource CounterButton}"
                                                        Command="{Binding DataContext.IncrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}">
                                                    <i:Interaction.Behaviors>
                                                        <behaviors:HoldClickBehavior
                                                            HoldCommand="{Binding DataContext.IncrementProgressCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            Interval="100"
                                                            InitialDelay="300"/>
                                                    </i:Interaction.Behaviors>
                                                </Button>
                                            </StackPanel>

                                            <ProgressBar Value="{Binding CurrentProgress}"
                                                         Maximum="{Binding MaxProgress}"
                                                         Style="{StaticResource TaskProgressBar}"
                                                         MinWidth="120"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Expander>

            </StackPanel>
        </ScrollViewer>

        <!-- ========== FOOTER ACTIONS ========== -->
        <Grid Grid.Row="3" Margin="0,12,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Daily Actions -->
            <WrapPanel Grid.Row="0" HorizontalAlignment="Left" Margin="0,0,0,6">
                <TextBlock Text="Daily:"
                           Foreground="#AAAAAA"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <Button Content="Select All"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding SelectAllDailyCommand}"
                        Margin="0,0,4,0"/>
                <Button Content="Deselect All"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding DeselectAllDailyCommand}"
                        Margin="0,0,12,0"/>

                <TextBlock Text="Weekly:"
                           Foreground="#AAAAAA"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <Button Content="Select All"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding SelectAllWeeklyCommand}"
                        Margin="0,0,4,0"/>
                <Button Content="Deselect All"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding DeselectAllWeeklyCommand}"/>
            </WrapPanel>

            <!-- General Actions -->
            <WrapPanel Grid.Row="1" HorizontalAlignment="Left">
                <ToggleButton Content="Show Completed"
                              IsChecked="{Binding ShowCompletedTasks}"
                              Style="{StaticResource ToggleActionButton}"
                              Margin="0,0,4,0"/>
                <Button Content="Export"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding ExportProgressCommand}"
                        Margin="0,0,4,0"/>
                <Button Content="Import"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding ImportProgressCommand}"
                        Margin="0,0,4,0"/>
                <Button Content="⟳ Refresh Timers"
                        Style="{StaticResource ActionButton}"
                        Command="{Binding RefreshTimersCommand}"/>
            </WrapPanel>
        </Grid>
    </Grid>
</UserControl>
